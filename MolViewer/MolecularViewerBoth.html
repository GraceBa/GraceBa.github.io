<!doctype HTML>
<html>
<head>
    <script src="https://graceba.github.io/MolViewer/aframe.js"></script>
    <script src="https://graceba.github.io/MolViewer/aframe-ar.js"></script>

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://graceba.github.io/MolViewer/Miew/Miew.min.css">
    <style>
        .miew-container {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
    </style>
</head>

<body style='margin : 0px; overflow: hidden;'>
    <a-scene id="currentScene" embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;' foo>

        <!-- *************************************************************************************************-->
        <!-- Custom js events -->
        <!-- *************************************************************************************************-->
        <script type="text/javascript">
//~~~~~~~~~~ define file sources
                var markersource = "https://graceba.github.io/MolViewer/Markers/";
                var modelsource = "https://graceba.github.io/MolViewer/Models/";

                function revertMarker(){
                    markersource = "https://graceba.github.io/MolViewer/Markers/";
                    document.getElementById("markerSourceInput").value = markersource;
                }
                function revertModel() {
                    modelsource = "https://graceba.github.io/MolViewer/Models/";
                    document.getElementById("modelSourceInput").value = modelsource;
                }

                function setMarkerSource() {
                    markersource = document.getElementById("markerSourceInput").value;
                }
                function setModelSource() {
                    modelsource = document.getElementById("modelSourceInput").value;
                }

//~~~~~~~~~~ Check for non-existent pattern files
               function trymePATT() {
                    var markername = document.getElementById("markerInput").value;
                    var marker = markersource + markername + ".patt";
                    var http = new XMLHttpRequest();
                    http.onload = function () {
                        trymeOBJ(this.status);
                    }
                    http.open('HEAD', marker, true);
                    http.send();
               }
//~~~~~~~~~~ Check for non-existent obj files
               function trymeOBJ(status) {
                   if (status === 200) {
                       var modelname = document.getElementById("modelInput").value;
                       var model = modelsource + modelname + ".obj";
                       var http = new XMLHttpRequest();
                       http.onload = function () {
                           trymeMTL(this.status);
                       }
                       http.open('HEAD', model, true);
                       http.send();
                   }
               }
//~~~~~~~~~~ Check for non-existent mtl files
               function trymeMTL(status) {
                   if (status === 200) {
                       var modelname = document.getElementById("modelInput").value;
                       var material = modelsource + modelname + ".mtl";
                       var http = new XMLHttpRequest();
                       http.onload = function () {
                           selectModel(this.status);
                       }
                       http.open('HEAD', material, true);
                       http.send();
                   }
               }

//~~~~~~~~~~ import a model
                function selectModel(status) {
                    //take user input
                    var modelname = document.getElementById("modelInput").value;     //name of 3D AR model
                    var markername = document.getElementById("markerInput").value;  //name of target image marker

                    if(!(document.getElementById(markername + modelname))){ //if the marker location exists and does not already have the called model
                        //*** if marker does not already exist, create it. ***
                        if (document.getElementById(markername) == null) {
                            //create a new a-marker element
                            var a_marker = document.createElement("a-marker");
                            var element = document.getElementById("currentScene");
                            element.appendChild(a_marker);
                            //set id as marker name
                            a_marker.setAttribute('id', markername);
                            // set the preset
                            a_marker.setAttribute('preset', 'custom');
                            // set the type
                            a_marker.setAttribute('type', 'pattern');
                            // set the url
                            a_marker.setAttribute('url', marker);
                        }

                        //*** set model on marker ***
                        //load model
                        var object = modelsource + modelname + ".obj";
                        var material = "";
                        if(status === 200){
                            material = modelsource + modelname + ".mtl";
                        }
                        var information = "Loaded model: " + modelname;
                        document.getElementById('info').innerHTML = information;

                        //create a model entity for the marker
                        var a_entity = document.createElement("a-entity");
                        var element = document.getElementById(markername);
                        element.appendChild(a_entity);
                        //set id as index
                        a_entity.setAttribute('id', markername + modelname);
                        //import empty model
                        a_entity.setAttribute("obj-model", "obj: url(" + object + "); mtl: url(" + material + ");");
                        //set the shadow
                        a_entity.setAttribute("shadow", "receive: false");
                        //set the position
                        a_entity.setAttribute("position", "0 1 0");
                        //set the scale
                        a_entity.setAttribute("scale", "1");
                    }
                }

//~~~~~~~~~~ remove selected model
                function hideModel() {
                    var markername = document.getElementById("markerInput").value;
                    var modelname = document.getElementById("modelInput").value;
                    //define the selected marker
                    var identity = markername + modelname;
                    if(document.getElementById(identity)) {
                        var element = document.getElementById(identity);
                        element.parentNode.removeChild(element);
                    }
                }

//~~~~~~~~~~ clear all models from a marker
                function clearMarker() {
                    var markername = document.getElementById("markerInput").value;
                    //define the selected marker
                    var i;
                    var currentInstances = document.getElementById(markername).getElementsByTagName('a-entity').length
                    for (i = 0; i < currentInstances; i++){
                        var identity = document.getElementById(markername).getElementsByTagName('a-entity')[0].id;
                        var element = document.getElementById(identity);
                        element.parentNode.removeChild(element);
                    }
                }

//~~~~~~~~~~ function that creates and loads miew container
                function loadViewer() {
                    var viewer = new Miew({
                        container: document.getElementsByClassName('miew-container')[0],
                        settings: {
                            theme: 'light',
                            fps: false,
                            axes: false,
                            bg: { color: 0xffffff, transparent: true },
                        }
                    });
                    if (viewer.init()) {
                        viewer.run();
                    }
                    var file = document.getElementById("fileSelect").value;
                    viewer.unload();
                    viewer.load(file);
                }

        </script>

        <!-- *************************************************************************************************-->
        <!-- CSS Style -->
        <!-- *************************************************************************************************-->
        <style>
            /*Collapsible menu style*/
            .collapsible {
                background-color: #777;
                color: white;
                cursor: pointer;
                padding: 10px;
                width: 100%;
                border: none;
                text-align: left;
                outline: none;
                font-size: 15px;
                float: right;
            }

                .active, .collapsible:hover {
                    background-color: #555;
                }

                .collapsible:after {
                    content: '\002B';
                    color: white;
                    font-weight: bold;
                    float: right;
                    margin-left: 5px;
                }

            .active:after {
                content: "\2212";
            }

            .content {
                padding: 0 18px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
                background-color: #f1f1f1;
            }

            .sidebar {
                background-color: #333;
                color: white;
                cursor: pointer;
                padding: 10px;
                width: 30%;
                border: none;
                text-align: left;
                outline: none;
                float: right;
                font-size: 15px;
                top: 0px;
            }

                .active1, .sidebar:hover {
                    background-color: #333;
                    width: 30%;
                }

                .sidebar:after {
                    content: '\002B';
                    color: white;
                    font-weight: bold;
                    float: right;
                    margin-left: 5px;
                }

            .sidecontent {
                height: 100%;
                width: 100%;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
                background-color: #f1f1f1;
            }

            .active1:after {
                content: "\2212";
            }

            p {
                padding: 3px;
            }
        </style>

        <!-- *************************************************************************************************-->
        <!-- Display -->
        <!-- *************************************************************************************************-->
        <!-- Default image -->
        <a-marker id="hexP" preset="custom" type="pattern" url="https://graceba.github.io/MolViewer/Markers/hexP.patt">
            <!-- Overlay object -->
            <a-entity obj-model="obj: url(https://graceba.github.io/MolViewer/Models/dna_chainA.obj); mtl: url(https://graceba.github.io/MolViewer/Models/dna_chainA.mtl);" shadow="receive: false;" position="0 1 0" scale="1" id="hexPdna_chainA"></a-entity>
        </a-marker>

        <!-- display information on active model -->
        <div style='position: fixed; bottom: 10px; left: 10px; width:100%; text-align: left; z-index: 4;'>
            <a id="info"></a>
        </div>

        <!-- Initiate camera -->
        <a-entity camera></a-entity>
    </a-scene>

    <div class="miew-container" style="width:640px; height:480px" z-index="2"></div>

    <!-- *************************************************************************************************-->
    <!-- Information and detailed menu -->
    <!-- *************************************************************************************************-->
    <div style='position: fixed; top: 10px; right: 0px; width:30%; text-align: left;'>
        <button class="sidebar">Menu</button>
        <div class="sidecontent">

            <button class="collapsible">How to</button>
            <div class="content">
                <p>
                    <a href="https://GraceBa.github.io/MolViewer/HowTo.html#loadingObjModel" target="_blank">Loading an obj model</a><br />
                    <a href="https://GraceBa.github.io/MolViewer/HowTo.html#changingSources" target="_blank">Changing sources</a><br />
                    <a href="https://GraceBa.github.io/MolViewer/HowTo.html#loadingProteinModel" target="_blank">Loading a protein model</a><br />
                </p>
            </div>

            <button class="collapsible">Load obj model</button>
            <div class="content">
                <p>
                    Marker: <input type="text" id="markerInput" value="hexP" /> <br />
                    Model : <input type="text" id="modelInput" value="dna_chainA" /> <br />

                    <!-- Buttons -->
                    <input onclick="trymePATT()" type="button" value="import model" id="selectButton" style="width: 50%;" /> <br />
                    <input onclick="hideModel()" type="button" value="remove model" id="hideButton" style="width: 50%;" /> <br />
                    <input onclick="clearMarker()" type="button" value="clear marker" id="clearButton" style="width: 50%;" /><br />
                </p>
                <script>
                    // recognise text submission via Enter key -> For adding markers
                    var pressEnter = document.getElementById("modelInput");
                    pressEnter.addEventListener("keyup", function (event) {
                        if (event.keyCode === 13) {
                            document.getElementById("selectButton").click();
                        }
                    });

                    var pressEnter1 = document.getElementById("markerInput");
                    pressEnter1.addEventListener("keyup", function (event) {
                        if (event.keyCode === 13) {
                            document.getElementById("selectButton").click();
                        }
                    });
                </script>
            </div>

            <button class="collapsible">Change source</button>
            <div class="content">
                <p>
                    Set marker source: <input type="text" id="markerSourceInput" value="" /> <br />
                    <input onclick="setMarkerSource()" type="button" value="set marker source" id="markerSourceButton" style="width: 55%;"> <br />
                    <input onclick="revertMarker()" type="button" value="revert" id="revertMarkerButton" style="width: 55%;"> <br />

                    Set obj model source: <input type="text" id="modelSourceInput" value="" /> <br />
                    <input onclick="setModelSource()" type="button" value="set model source" id="modelSourceButton" style="width: 55%;"> <br />
                    <input onclick="revertModel()" type="button" value="revert" id="revertModelButton" style="width: 55%;"> <br />

                </p>
            </div>

            <button class="collapsible">Load protein model</button>
            <div class="content">
                <p>
                    <input type="text" id="fileSelect" value="1crn" /> <br />
                    <input type="button" value="load" id="fileChange" onclick="loadViewer()" /> <br />
                </p>
                <script>
                    var pressEnter = document.getElementById("fileSelect");
                    pressEnter.addEventListener("keyup", function (event) {
                        if (event.keyCode === 13) {
                            document.getElementById("fileChange").click();
                        }
                    });
                </script>
            </div>
        </div>
        <script>
                // control the collapsing menu
                var coll = document.getElementsByClassName("collapsible");
                var x;

                for (x = 0; x < coll.length; x++) {
                    coll[x].addEventListener("click", function () {
                        this.classList.toggle("active");
                        var content = this.nextElementSibling;
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                }

                document.getElementsByClassName("sidebar")[0].addEventListener("click", function () {
                    this.classList.toggle("active1");
                    var sidecontent = this.nextElementSibling;
                    if (sidecontent.style.maxHeight) {
                        sidecontent.style.maxHeight = null;
                    } else {
                        sidecontent.style.maxHeight = "100%";
                    }
                });

        </script>
    </div>

    <script src="https://unpkg.com/@babel/polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://graceba.github.io/MolViewer/Miew/Miew.min.js"></script>

</body>
</html>
