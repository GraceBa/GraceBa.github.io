<!doctype HTML>
<html>
    <script src="https://cdn.jsdelivr.net/gh/GraceBa/ARvis/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/GraceBa/ARvis/DNA/aframe-ar.js"></script>
    <meta charset="UTF-8">

<body style='margin : 0px; overflow: hidden;'>
    <a-scene id="currentScene" embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;' foo>

        <!-- Custom js events -->
        <script type="text/javascript">

//~~~~~~~~~~ Check for non-existent pattern files
            function tryme() {
                var markername = document.getElementById("markerInput").value;
                var marker = "https://raw.githubusercontent.com/GraceBa/ARvis/master/MolViewer/Markers/" + markername + ".patt";
                var http = new XMLHttpRequest();
                http.onload = function () {
                    selectModel(this.status, marker);
                }
                http.open('HEAD', marker, true);
                http.send(); 
                //selectModel(200,marker)
            }


//~~~~~~~~~~ import a model
            function selectModel(status, marker) {
                //take user input
                var modelname = document.getElementById("userInput").value;
                var markername = document.getElementById("markerInput").value;

                if (status === 200) {
                    //*** if marker does not already exist, create it. ***
                    if (document.getElementById(markername) == null) {
                        //if (UrlExists(marker)) {
                        //note the index of the new marker
                        var markernumber = document.getElementsByTagName("a-marker").length;
                        //create a new a-marker element
                        var a_marker = document.createElement("a-marker");
                        var element = document.getElementById("currentScene");
                        element.appendChild(a_marker);

                        //set id as marker name
                        a_marker.setAttribute('id', markername);
                        // set the preset
                        a_marker.setAttribute('preset', 'custom');
                        // set the type
                        a_marker.setAttribute('type', 'pattern');
                        // set the url
                        a_marker.setAttribute('url', marker);

                        //create a model entity for the marker
                        var a_entity = document.createElement("a-entity");
                        var element = document.getElementsByTagName("a-marker")[markernumber];
                        element.appendChild(a_entity);

                        //set id as index
                        a_entity.setAttribute('id', markernumber.toString());
                        //import empty model
                        var newObjModel = "obj: url(); mtl: url();";
                        a_entity.setAttribute("obj-model", newObjModel);
                        //set the shadow
                        a_entity.setAttribute("shadow", "recieve: false");
                        //set the position
                        a_entity.setAttribute("position", "0 1 0");
                        //set the scale
                        a_entity.setAttribute("scale", "1");

                        var information = "Loaded marker: " + markername;
                        document.getElementById('info').innerHTML = information;
                    }

                    //*** set model on marker ***
                    //load model
                    var object = "https://raw.githubusercontent.com/GraceBa/ARvis/master/MolViewer/Models/" + modelname + ".obj";
                    var material = "https://raw.githubusercontent.com/GraceBa/ARvis/master/MolViewer/Models/" + modelname + ".mtl";
                    var information = "Loaded model: " + modelname;
                    document.getElementById('info').innerHTML = information;

                    //define the selected marker
                    var index = document.getElementById(markername).getElementsByTagName('a-entity')[0].id;
                    var display = document.getElementById(index);
                    display.setAttribute("obj-model", "obj: url(" + object + "); mtl: url(" + material + ");");
                }
            }

//~~~~~~~~~~ remove a model
            function hideModel() {
                var markername = document.getElementById("markerInput").value;
                //define the selected marker
                var index = document.getElementById(markername).getElementsByTagName('a-entity')[0].id;
                var display = document.getElementById(index);
                //hide model
                display.setAttribute("obj-model", "obj: url(); mtl: url();");
            }


//~~~~~~~~~~ Molecular viewer?? ngl
 /*           var file = "rcsb://1crn";
            var stage;
            var represent = "cartoon";

            function changeFile() {
                file = "rcsb://" + document.getElementById("fileSelect").value;
                document.getElementById("viewport").innerHTML = '';
                var stage = new NGL.Stage("viewport");
                stage.loadFile(file).then(function (o) {
                    o.addRepresentation(represent);
                    o.autoView();
                });
                //document.getElementById("info").innerHTML = file;
            }

            document.addEventListener("DOMContentLoaded", function () {
                var stage = new NGL.Stage("viewport");
                stage.loadFile(file, { defaultRepresentation: true });
                document.getElementById("info").innerHTML = file;
            }); */


        </script>

        <!-- User Interaction -->
        <!-- Import model button -->
        <div style='position: fixed; top: 10px; left: 10px; width:100%; text-align: left; z-index: 1;'>
            Marker: <input type="text" id="markerInput" value="hexP" /> <br />
            Model : <input type="text" id="userInput" value="dna_chainA" /> <br />
            <input onclick="tryme()" type="button" value="import model" id="selectButton"> <br />
            <input onclick="hideModel()" type="button" value="remove model" id="hideButton"> <br />

            <!--Molecular viewer?? ngl
            <input type="text" id="fileSelect" value="1crn" /> <br />
            <input type="button" onclick="changeFile()" value="load" id="fileChange" /> <br /> -->

            <script>
            var pressEnter = document.getElementById("userInput");
            pressEnter.addEventListener("keyup", function (event) {
                if (event.keyCode === 13) {
                    document.getElementById("selectButton").click();
                }
            });

            var pressEnter1 = document.getElementById("markerInput");
            pressEnter1.addEventListener("keyup", function (event) {
                if (event.keyCode === 13) {
                    document.getElementById("selectButton").click();
                }
            });
            </script>
        </div>

        <!-- display information on active model -->
        <div style='position: fixed; bottom: 10px; left: 10px; width:100%; text-align: left; z-index: 1;'>
            <a id="info"></a>
        </div>


        <!-- control scale and rotation
        <script src="https://cdn.jsdelivr.net/gh/GraceBa/ARvis/DNA/hammer.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/GraceBa/ARvis/DNA/controlHammer.js"></script> -->
        <!-- Recognise image -->
        <a-marker id="hexP" preset="custom" type="pattern" url="https://raw.githubusercontent.com/GraceBa/ARvis/master/MolViewer/Markers/hexP.patt">
            <!-- Overlay object -->
            <a-entity obj-model="obj: url(https://raw.githubusercontent.com/GraceBa/ARvis/master/DNA/dna_chainA.obj); mtl: url(https://raw.githubusercontent.com/GraceBa/ARvis/master/DNA/dna_chainA.mtl);" shadow="recieve: false;" position="0 1 0" scale="1" id="0"></a-entity>
        </a-marker>

        <!-- Initiate camera -->
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
